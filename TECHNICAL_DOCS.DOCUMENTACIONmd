# DocumentaciÃ³n TÃ©cnica Detallada

## ğŸ“š Ãndice
1. [Frontend](#frontend)
2. [Backend](#backend)
3. [Base de Datos](#base-de-datos)
4. [API de Gemini](#api-de-gemini)
5. [Utilidades](#utilidades)

## Frontend

### ğŸ”„ Ciclo de Vida de la AplicaciÃ³n

#### `initApp()`
```javascript
async function initApp()
```
**PropÃ³sito**: Inicializa la aplicaciÃ³n web.
**Proceso**:
1. Obtiene referencias DOM:
   - `debateTable`: Tabla principal del debate
   - `btnGenerar`: BotÃ³n para nuevo debate
   - `btnContinuar`: BotÃ³n para continuar debate
   - `btnLimpiar`: BotÃ³n para limpiar debate
   - `btnPdf`: BotÃ³n para exportar a PDF
2. Verifica existencia de elementos
3. Configura event listeners
4. Carga debate previo si existe

### ğŸ’¬ GestiÃ³n de Mensajes

#### `addMessage(tema, coach, contexto)`
```javascript
async function addMessage(tema, coach, contexto)
```
**ParÃ¡metros**:
- `tema`: String - Tema del debate
- `coach`: String - 'CrossFit' o 'HEROS'
- `contexto`: String - Mensaje anterior (opcional)

**Proceso**:
1. ValidaciÃ³n de parÃ¡metros
2. PreparaciÃ³n de datos para API
3. Llamada a Gemini API
4. Almacenamiento en MongoDB
5. ActualizaciÃ³n de interfaz

**Manejo de Errores**:
- Valida campos requeridos
- Captura errores de red
- Maneja errores de API
- Muestra mensajes de error al usuario

#### `updateMessage(mensajeId, nuevoMensaje)`
```javascript
async function updateMessage(mensajeId, nuevoMensaje)
```
**ParÃ¡metros**:
- `mensajeId`: String - ID del mensaje a actualizar
- `nuevoMensaje`: String - Nuevo contenido

**Proceso**:
1. Localiza mensaje en la tabla
2. Identifica coach actual
3. Actualiza en base de datos
4. Regenera respuestas posteriores
5. Actualiza interfaz

**CaracterÃ­sticas Especiales**:
- Mantiene coherencia del debate
- Regenera respuestas automÃ¡ticamente
- Preserva turnos correctos

### ğŸ¯ ManipulaciÃ³n del DOM

#### `addToTable(coach, mensaje, mensajeId)`
```javascript
function addToTable(coach, mensaje, mensajeId)
```
**ParÃ¡metros**:
- `coach`: String - Identificador del coach
- `mensaje`: String - Contenido del mensaje
- `mensajeId`: String - ID Ãºnico del mensaje

**Estructura HTML Generada**:
```html
<tr>
  <td class="[coach]-message">
    <div class="message-container" data-message-id="[mensajeId]">
      <p>[mensaje]</p>
      <div class="action-buttons">
        <button class="edit-btn">âœï¸</button>
        <button class="delete-btn">ğŸ—‘ï¸</button>
      </div>
    </div>
  </td>
</tr>
```

**CaracterÃ­sticas**:
- Estructura semÃ¡ntica
- Botones de acciÃ³n ocultos
- Estilos dinÃ¡micos por coach
- Auto-scroll al nuevo mensaje

### ğŸ” Utilidades Frontend

#### `findMessageRowById(mensajeId)`
```javascript
function findMessageRowById(mensajeId)
```
**PropÃ³sito**: Localiza la fila de un mensaje especÃ­fico
**Retorno**: Element | null

#### `showError(message)`
```javascript
function showError(message)
```
**CaracterÃ­sticas**:
- Muestra error 5 segundos
- AnimaciÃ³n fade in/out
- Estilo destacado
- Auto-limpieza

## Backend

### âš™ï¸ ConfiguraciÃ³n del Servidor

#### Middleware
```javascript
app.use(cors({
    origin: '*',
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));
```

#### ConexiÃ³n MongoDB
```javascript
mongoose.connect(process.env.MONGODB_URI)
```
**Eventos Monitoreados**:
- ConexiÃ³n exitosa
- DesconexiÃ³n
- Error
- ReconexiÃ³n

### ğŸ“¡ API Endpoints

#### POST /api/generar-respuesta
```javascript
app.post('/api/generar-respuesta', async (req, res) => {})
```
**Body**:
```json
{
    "tema": "string",
    "estilo": "CrossFit|HEROS",
    "contexto": "string?"
}
```
**Respuesta**:
```json
{
    "success": true,
    "respuesta": "string"
}
```

#### POST /api/guardar-mensaje
**Body**:
```json
{
    "tema": "string",
    "coach": "CrossFit|HEROS",
    "mensaje": "string"
}
```
**Respuesta**:
```json
{
    "success": true,
    "debateId": "string",
    "mensaje": "object"
}
```

#### PUT /api/mensajes/:id
**ParÃ¡metros**:
- `id`: ID del mensaje

**Body**:
```json
{
    "mensaje": "string"
}
```

#### DELETE /api/mensajes/:id
**ParÃ¡metros**:
- `id`: ID del mensaje

### ğŸ¤– GeneraciÃ³n de Prompts

#### `generatePrompt(tema, estilo, contexto)`
```javascript
function generatePrompt(tema, estilo, contexto)
```
**Perfiles de Coach**:
```javascript
const coachProfiles = {
    CrossFit: {
        personalidad: "apasionado y directo",
        enfoque: "resultados medibles y adaptaciones rÃ¡pidas"
    },
    HEROS: {
        personalidad: "analÃ­tico y metÃ³dico",
        enfoque: "precisiÃ³n tÃ©cnica y progresiÃ³n cientÃ­fica"
    }
};
```

**Formato de Prompt**:
```
Eres un coach de [estilo] respondiendo en un debate sobre: "[tema]".
Tu personalidad es [personalidad] y te enfocas en [enfoque].
[Si hay contexto: Responde al Ãºltimo mensaje de manera breve...]
[Si no hay contexto: Da una opiniÃ³n breve sobre el tema...]
```

## Base de Datos

### ğŸ“Š Esquema de Datos

#### Debate
```javascript
const DebateSchema = new mongoose.Schema({
    tema: { 
        type: String, 
        required: true 
    },
    coach: { 
        type: String, 
        required: true, 
        enum: ['CrossFit', 'HEROS'] 
    },
    mensaje: { 
        type: String, 
        required: true 
    },
    fecha: { 
        type: Date, 
        default: Date.now 
    }
});
```

### ğŸ”„ Ãndices
```javascript
DebateSchema.index({ fecha: -1 });
DebateSchema.index({ tema: 1, fecha: -1 });
```

## API de Gemini

### ğŸ”‘ ConfiguraciÃ³n
```javascript
const API_KEY = process.env.GEMINI_API_KEY;
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`;
```

### ğŸ“ Formato de Solicitud
```javascript
const requestBody = {
    contents: [{
        parts: [{
            text: promptText
        }]
    }]
};
```

### ğŸ¯ ParÃ¡metros de Control
- MÃ¡ximo 2 oraciones por respuesta
- Tono profesional y competitivo
- Respuestas contextualizadas
- Preguntas de seguimiento

## Utilidades

### ğŸ“¤ ExportaciÃ³n PDF
```javascript
async function exportToPDF()
```
**CaracterÃ­sticas**:
- TÃ­tulo formateado
- Mensajes organizados por coach
- Estilos consistentes
- PaginaciÃ³n automÃ¡tica
- Pie de pÃ¡gina con fecha

### ğŸ§¹ Limpieza de Datos
```javascript
async function clearDebate()
```
**Acciones**:
1. Limpia frontend
2. Elimina datos en MongoDB
3. Reinicia variables de estado
4. Actualiza interfaz

### ğŸ” Debugging
```javascript
console.log('ğŸ“ Procesando:', { 
    accion: 'string',
    datos: 'object',
    timestamp: 'date'
});
```

## ğŸ¨ Estilos Detallados

### Variables CSS
```css
:root {
    --crossfit-color: #6c5ce7;
    --heros-color: #74b9ff;
    --error-color: #ff76bc;
    --background: #f0f2ff;
}
```

### Animaciones
```css
@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-10px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}
```

### Media Queries
```css
@media (max-width: 768px) {
    .controls {
        flex-direction: column;
    }
    .debate-container {
        max-height: 70vh;
    }
}
```

## ğŸ”’ Seguridad

### Validaciones
1. SanitizaciÃ³n de entradas
2. ValidaciÃ³n de tipos
3. LÃ­mites de longitud
4. VerificaciÃ³n de roles

### CORS
- Origen permitido: *
- MÃ©todos: GET, POST, PUT, DELETE
- Headers: Content-Type, Authorization

### Manejo de Errores
1. Try-catch en todas las operaciones
2. Logging estructurado
3. Respuestas de error consistentes
4. Timeout en operaciones async 